# ネットワークインフラストラクチャ設計

[English](../en/README.md) | [繁體中文](../zh-tw/README.md) | [日本語](README.md)

### ネットワークアーキテクチャ図
```
+-------------------------------------------------------------------------------------+
|                                                                                     |
|  VPC (10.0.0.0/16)                                                                  |
|                                                                                     |
|  +------------------------------+            +--------------------------------+     |
|  |                              |            |                                |     |
|  |  AZ: ap-northeast-1a         |            |  AZ: ap-northeast-1c           |     |
|  |                              |            |                                |     |
|  |  +------------------------+  |            |  +------------------------+    |     |
|  |  | Public Subnet          |  |            |  | Public Subnet          |    |     |
|  |  | (10.0.1.0/24)          |  |            |  | (10.0.2.0/24)          |    |     |
|  |  |                        |  |            |  |                        |    |     |
|  |  |  +------------------+  |  |            |  |  +------------------+  |    |     |
|  |  |  | NAT Gateway      |  |  |            |  |  | NAT Gateway      |  |    |     |
|  |  |  | + EIP            |  |  |            |  |  | + EIP            |  |    |     |
|  |  |  +--------+---------+  |  |            |  |  +--------+---------+  |    |     |
|  |  |           |            |  |            |  |           |            |    |     |
|  |  +-----------|------------+  |            |  +-----------|------------+    |     |
|  |              |               |            |              |                 |     |
|  |  +-----------v------------+  |            |  +-----------v------------+    |     |
|  |  | Private Subnet         |  |            |  | Private Subnet         |    |     |
|  |  | (10.0.11.0/24)         |  |            |  | (10.0.12.0/24)         |    |     |
|  |  |                        |  |            |  |                        |    |     |
|  |  | +--------------------+ |  |            |  | +--------------------+ |    |     |
|  |  | | VPC Endpoint ENIs  | |  |            |  | | VPC Endpoint ENIs  | |    |     |
|  |  | | (インターフェイス型)  | |  |            |  | | (インターフェイス型)  | |    |     |
|  |  | +--------------------+ |  |            |  | +--------------------+ |    |     |
|  |  +------------------------+  |            |  +------------------------+    |     |
|  |                              |            |                                |     |
|  +------------------------------+            +--------------------------------+     |
|                                                                                     |
|  +-------------------------+         +-------------------------+        +---------+ |
|  | Route Table (public)    |         | Route Tables (private)  | <----> | Gateway | |
|  | 0.0.0.0/0 -> IGW        |         | 0.0.0.0/0 -> NAT        |        | VPC     | |
|  +-----------|------------+         +--------------------------+        | Endpoints| |
|              |                                                          | (S3,     | |
|              v                                                          | DynamoDB)| |
|  +-------------------------+                                            +---------+ |
|  | Internet Gateway        |                                                        |
|  +-----------|------------+                                                         |
|              |                                                                      |
+--------------|----------------------------------------------------------------------+
               |
               v
         +-------------+
         |  Internet   |
         +-------------+
```

> **図の制限事項について：** 上記の図では、アベイラビリティゾーン（AZ）とインターネットゲートウェイ（IGW）またはルートテーブルとの直接的な接続を明示的に示していません。その理由は以下の通りです：
> 
> 1. **概念的な階層化：** AWS アーキテクチャでは、インターネットゲートウェイとルートテーブルは論理的に VPC 全体に接続されており、AZ に直接接続されているわけではありません。AZ は AWS の物理的なインフラストラクチャの区分であり、IGW やルートテーブルなどのネットワークコンポーネントは論理的な設定です。
> 
> 2. **実際の関係：**
>    - インターネットゲートウェイは VPC レベルで接続されています
>    - ルートテーブルは VPC レベルで設定され、特定のサブネットに関連付けられます
>    - サブネットは特定の AZ 内に存在します
> 
> 3. **図の明確さ：** これらのクロス接続を追加すると、図が著しく複雑になり、混乱を招く可能性があります。現在の表現は、すべての論理的な関係ではなく、トラフィックの機能的な流れに焦点を当てています。
> 
> これらの関係をより包括的に視覚化するには、AWS アーキテクチャ図、Lucidchart、draw.io などの専門的な図表作成ツールをお勧めします。

### アーキテクチャツリー構造
```
aws_vpc.this
├── aws_internet_gateway.this  ───→ パブリック出入口
├── aws_subnet.public[N]
│   └── aws_route_table.public に紐付け → IGW 経由を指定
│       └── aws_route.igw
├── aws_subnet.private[N]
│   └── aws_route_table.private[N] に紐付け → NAT 経由を指定
│       └── aws_route.nat[N]
├── aws_nat_gateway.this[N]
│   ├── パブリックサブネットに配置
│   └── aws_eip.nat[N] を出口アドレスとして使用
├── aws_vpc_endpoint (ゲートウェイ型)
│   ├── S3 (すべてのルートテーブルに接続)
│   └── DynamoDB (すべてのルートテーブルに接続)
├── aws_vpc_endpoint (インターフェイス型)
│   ├── ECR API (プライベートサブネットに接続)
│   ├── ECR Docker (プライベートサブネットに接続)
│   └── CloudWatch Logs (プライベートサブネットに接続)
├── aws_network_acl.public
│   └── すべての受信・送信トラフィックを許可
├── aws_network_acl.private
│   ├── 受信は VPC 内部トラフィックのみ許可
│   └── 送信はすべてのトラフィックを許可
└── aws_flow_log.vpc_flow_log
    └── すべてのネットワークトラフィックを CloudWatch Logs に記録
```

### リファレンスシーケンスとロジック
1. aws_vpc.this
 - 各リソースは VPC に接続されています。VPC は基盤であり、他のすべてのネットワークコンポーネントの「親」です。

2. aws_internet_gateway.this
 - VPC と 1対1 で結合され、パブリックサブネットに外部ネットワークアクセスを提供します。
 - IGW は AWS が提供する「外部 NAT」デバイスで、パブリックサブネット用です。

3. aws_subnet.public + aws_subnet.private
 - パブリックサブネットは map_public_ip_on_launch = true に設定されており、ここで起動される EC2 インスタンスには自動的にパブリック IP が割り当てられます。
 - 各サブネットは AZ と CIDR ブロック（地域アドレス範囲）を指定します。

4. aws_eip.nat
 - EIP（Elastic IP）= 固定のパブリック IP アドレス
 - AWS はデフォルトで NAT ゲートウェイに動的 IP を割り当てますが、プライベートサブネットが常に同じ送信 IP を使用するようにしたい場合（例：外部データベースのホワイトリスト登録用）、EIP が必要です。
 - ここでは count = length(var.azs) となっており、各 AZ に NAT 用の固定 IP を用意しています。

5. aws_nat_gateway.this
 - これはプライベートサブネットがインターネットにアクセスするための「プロキシ」で、仲介役として機能します。
 - 各 NAT ゲートウェイ：
  - パブリックサブネットを起点として使用（subnet_id = aws_subnet.public[count.index].id）
  - 上記の EIP に固定 IP として結合されています。
 - これはプライベートサブネットが「安全にインターネットにアクセスする」ために重要です。

6. aws_route_table.public + aws_route.igw
 - 「パブリックエリア」のルートテーブルを作成し、「宛先が 0.0.0.0/0（世界全体）の場合、IGW を経由する」と指定します。
 - そして aws_route_table_association.public を使用して、このルートテーブルを各パブリックサブネットに割り当てます。

7. aws_route_table.private + aws_route.nat
 - 各プライベートサブネット用に個別のルートテーブルを作成します。
 - 「外部世界に接続する場合は、NAT ゲートウェイを経由する」と指定します。
 - ルートテーブルは route_table_association を通じてサブネットにバインドされる必要があります。

8. aws_vpc_endpoint (ゲートウェイ型)
 - パブリックインターネットを経由せずに VPC 内部から AWS サービスに直接接続する方法を提供します。
 - S3 と DynamoDB のエンドポイントはゲートウェイ型で、ルートテーブルに直接追加されます。
 - この接続方法は NAT ゲートウェイのコストを節約し、セキュリティとパフォーマンスを向上させることができます。

9. aws_vpc_endpoint (インターフェイス型)
 - ECR API、ECR Docker、CloudWatch Logs 用に作成されたエンドポイント。
 - これらはインターフェイス型で、指定された各プライベートサブネットに ENI（Elastic Network Interface）を配置します。
 - トラフィックを制御するためのセキュリティグループの指定が必要です。
 - プライベート DNS が有効になっており、標準の AWS サービス DNS 名が自動的に VPC エンドポイント IP に解決されます。

10. aws_network_acl (ネットワークアクセスコントロールリスト)
 - サブネットレベルのファイアウォールとして機能し、セキュリティグループを補完します。
 - パブリックサブネットの NACL はすべてのトラフィックの出入りを許可しており、外部世界と直接通信する必要があるサービスに適しています。
 - プライベートサブネットの NACL は VPC 内部からのインバウンドトラフィックのみを許可し、すべてのアウトバウンドトラフィックを許可することで、セキュリティを強化します。

11. aws_flow_log.vpc_flow_log
 - すべての VPC ネットワークトラフィックを記録し、セキュリティ監査やトラブルシューティングに役立ちます。
 - ログは CloudWatch Logs に保存され、保持期間は 5 日です。
 - VPC が CloudWatch にログを書き込むための特定の IAM ロールが必要です。

### CIDR 配分計画
- VPC CIDR: 10.0.0.0/16（65,536 個の IP アドレスを提供）
- パブリックサブネット:
  - ap-northeast-1a: 10.0.1.0/24（256 個の IP）
  - ap-northeast-1c: 10.0.2.0/24（256 個の IP）
- プライベートサブネット:
  - ap-northeast-1a: 10.0.11.0/24（256 個の IP）
  - ap-northeast-1c: 10.0.12.0/24（256 個の IP）

### 要約
1. VPC は土地 → サブネットはゾーン
2. IGW はインターネット接続を確立 → パブリックエリア用
3. NAT Gateway + EIP はプライベートエリアの「ファイアウォール + インターネットアクセスチャネル」を形成
4. ルートテーブルは各サブネットに「どのように外に出るか」を伝えるだけ
5. VPC エンドポイントはプライベートサブネットがパブリックインターネットを経由せずに AWS サービスに安全にアクセスすることを可能にします
6. ネットワーク ACL はサブネットレベルのトラフィック制御を提供
7. VPC フローログはモニタリングとトラブルシューティングのためにトラフィックを記録 