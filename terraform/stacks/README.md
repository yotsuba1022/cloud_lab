# Terraform Environment Management

This directory manages different environments for Terraform backend configurations. Each environment has its own set of components and configurations.

## Directory Structure

```
terraform/envs/
├── dev/                   # Development environment
│   ├── .env               # Environment variables for dev
│   ├── networking/        # Networking component
│   │   └── backend.hcl    # Generated backend config
│   ├── compute/           # Compute component
│   │   └── backend.hcl    # Generated backend config
│   └── ...                # Other components
├── backend.tpl.hcl        # Backend configuration template
└── gen_backend.sh         # Script to generate backend.hcl files
```

## Environment Management

Currently, we have the `dev` environment set up. The structure is designed to be extensible, allowing for additional environments (e.g., `staging`, `prod`) to be added as needed.

Each environment directory contains:
- `.env` file with environment-specific variables
- Component-specific directories (e.g., `networking`, `compute`)
- Generated `backend.hcl` files for each component

## Backend Configuration Generation

The `gen_backend.sh` script automates the generation of `backend.hcl` files for each component. It uses environment variables from the `.env` file to populate the backend configuration template.

### Usage

```bash
./gen_backend.sh <environment> <module> <key>
```

Example:
```bash
./gen_backend.sh dev infra/networking infra-networking
```

### Script Details

The script:
1. Sources environment variables from the specified environment's `.env` file
2. Validates required variables (BUCKET, REGION, LOCK_TABLE, MODULE, KEY)
3. Creates the component directory if it doesn't exist
4. Generates `backend.hcl` using the template `backend.tpl.hcl` and environment variables

### Required Environment Variables

The `.env` file should contain:
- `BUCKET`: S3 bucket name for Terraform state
- `REGION`: AWS region
- `BUCKET`: The bucket name that generated by the state-storage module
- `LOCK_TABLE`: DynamoDB table name for state locking
- Additional variables as needed for the environment

## Adding New Environments

To add a new environment:
1. Create a new directory (e.g., `staging`)
2. Copy and modify the `.env` file from an existing environment
3. Create component directories as needed
4. Use `gen_backend.sh` to generate backend configurations 
