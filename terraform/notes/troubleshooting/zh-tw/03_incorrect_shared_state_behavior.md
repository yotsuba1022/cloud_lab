# Terraform State ç®¡ç†éŒ¯èª¤å°è‡´çš„è³‡æºç•°å‹•å•é¡Œ

[English](../en/03_incorrect_shared_state_behavior.md) | [ç¹é«”ä¸­æ–‡](03_incorrect_shared_state_behavior.md) | [æ—¥æœ¬èª](../ja/03_incorrect_shared_state_behavior.md) | [è¿”å›ç´¢å¼•](../README.md)

---

## èƒŒæ™¯
- å¯¦é©—æ—¥æœŸï¼š2025/05/24
- é›£åº¦ï¼šğŸ¤¬ğŸ¤¬
- æè¿°ï¼šä½¿ç”¨ Terraform ç®¡ç†å¤šæ¨¡çµ„ï¼ˆ`infra-networking` èˆ‡ `isolated-ec2`ï¼‰æ™‚ï¼Œæœªæ­£ç¢ºåŠƒåˆ† backendï¼Œå°è‡´å½¼æ­¤ç‹€æ…‹é‡ç–Šä¸¦èª¤åˆªè³‡æºã€‚

---

## é‡åˆ°çš„ç¾è±¡

- `infra-networking` æˆåŠŸ applyï¼Œä¸”åœ¨ AWS Console ä¸­èƒ½æ¸…æ¥šçœ‹åˆ°å»ºç«‹å¥½çš„è³‡æºï¼ˆVPCã€Subnetã€Route Table ç­‰ï¼‰
- æ¥è‘—åŸ·è¡Œ `isolated-ec2` çš„ `terraform plan`ï¼ŒTerraform å»è©¦åœ–ç§»é™¤å‰›å‰› `infra-networking` æ‰€å»ºç«‹çš„è³‡æº
- é€™èˆ‡æˆ‘å€‘é æœŸã€Œç–ŠåŠ ã€çš„ç‹€æ…‹ç®¡ç†æ–¹å¼ä¸åŒï¼Œåè€Œåƒæ˜¯å…©å€‹æ¨¡çµ„åŒæ™‚æ“ä½œåŒä¸€ä»½ context

---

## éŒ¯èª¤ç¤ºæ„æ¶æ§‹åœ–

### âŒ infra-network èˆ‡ isolated-ec2 å…±ç”¨åŒä¸€å€‹ terraform state

```
ğŸ“ state-storage/
â””â”€â”€ dev-backend.hcl     --> æä¾›å…±ç”¨ backend

ğŸ“ infra-network/
â””â”€â”€ main.tf             --> ä½¿ç”¨ dev-backend.hcl

ğŸ“ isolated-ec2/
â””â”€â”€ main.tf             --> ä¹Ÿä½¿ç”¨ dev-backend.hcl

ğŸ“¦ AWS S3
â””â”€â”€ key = dev/terraform.tfstate
    â””â”€â”€ state åŒ…å« infra + ec2 çš„æ‰€æœ‰è³‡æº
```

```
          +-----------------------------+
          |  S3: dev/terraform.tfstate  |
          +-----------------------------+
                  â–²          â–²
                  |          |
       +----------+          +----------+
       |                                |
+---------------+             +------------------+
| infra-network |             |  isolated-ec2    |
+---------------+             +------------------+
(å…±äº«åŒä¸€å€‹ stateï¼Œäº’ç›¸å½±éŸ¿)
```

---

## ä¿®æ­£å¾Œçš„åšæ³•

### âœ… infra-network èˆ‡ isolated-ec2 ä½¿ç”¨ç¨ç«‹çš„ terraform state

```
ğŸ“ state-storage/
â”œâ”€â”€ dev-infra.hcl       --> çµ¦ infra-network ç”¨
â””â”€â”€ dev-ec2.hcl         --> çµ¦ isolated-ec2 ç”¨

ğŸ“ infra-network/
â””â”€â”€ main.tf             --> ä½¿ç”¨ dev-infra.hcl

ğŸ“ isolated-ec2/
â””â”€â”€ main.tf             --> ä½¿ç”¨ dev-ec2.hcl

ğŸ“¦ AWS S3
â”œâ”€â”€ key = dev/infra/terraform.tfstate
â””â”€â”€ key = dev/ec2/terraform.tfstate
```

```
          +---------------------------------+       +--------------------------------+
          | S3: dev/infra/terraform.tfstate |       | S3: dev/ec2/terraform.tfstate  |
          +---------------------------------+       +--------------------------------+
                           â–²                                        â–²
                           |                                        |
                           |                                        |
                   +---------------+                       +------------------+
                   | infra-network |                       |  isolated-ec2    |
                   +---------------+                       +------------------+
                                      (å½¼æ­¤ç¨ç«‹ï¼Œä¸äº’ç›¸å½±éŸ¿)
```

---

## é™¤éŒ¯éç¨‹

- æœ€åˆåªå»ºç«‹äº† `infra-networking` çš„ backend è¨­å®šæª”ï¼Œä¸”æˆåŠŸå°‡ç‹€æ…‹å¯«å…¥ S3
- ä½† `isolated-ec2` æ²’æœ‰è‡ªå·±çš„ backend è¨­å®šæª”ï¼Œå°è‡´ terraform init æ™‚æ²¿ç”¨é è¨­ï¼ˆæˆ–é‡è¤‡ä½¿ç”¨ dev-backend.hclï¼‰
- Terraform èª¤ä»¥ç‚ºæ•´å€‹ state éƒ½æ­¸ isolated-ec2 æ‰€æœ‰ï¼Œå› æ­¤æ‰“ç®—ã€ŒåŒæ­¥ã€æˆ isolated-ec2 çš„ç‹€æ…‹ï¼ˆä¹Ÿå°±æ˜¯åˆªé™¤ infra çš„æ±è¥¿ï¼‰

---

## è§£æ±ºæ–¹å¼

1. ç‚º `isolated-ec2` å»ºç«‹å°ˆå±¬çš„ backend è¨­å®šæª”ï¼ˆhclï¼‰
2. æ¡ç”¨è…³æœ¬è‡ªå‹•ç”¢ç”Ÿ backend è¨­å®šï¼Œä¸¦ä¾ç…§ç’°å¢ƒèˆ‡æ¨¡çµ„å‘½åè¦å‰‡å­˜æ”¾
3. backend ç‹€æ…‹æª”é…ç½®ç¨ç«‹çš„ key èˆ‡ DynamoDB Lock Tableï¼Œé¿å…èˆ‡å…¶ä»–æ¨¡çµ„è¡çª
4. ä¿®æ­£å¾Œå†æ¬¡ `terraform init` â†’ `plan`ï¼Œå°±ä¸å†å‡ºç¾åˆªé™¤å…¶ä»–æ¨¡çµ„è³‡æºçš„éŒ¯èª¤

---

## èªªæ˜è£œå……

æ­¤è™•çš„ backend è¨­å®šæ¡ç”¨äº†ã€Œä»¥ç’°å¢ƒ + æ¨¡çµ„ã€ç‚ºåŸºç¤çš„ç¨ç«‹è³‡æ–™å¤¾å„²å­˜æ–¹å¼ï¼Œä¸¦é€é shell è…³æœ¬è‡ªå‹•ç”Ÿæˆå°æ‡‰çš„ `backend.hcl`ã€‚é€™æ¨£çš„æ–¹å¼èƒ½å¤§å¹…é™ä½å‡ºéŒ¯æ©Ÿç‡ï¼Œä¹Ÿä¾¿æ–¼å¾ŒçºŒç¶­è­·ã€‚

æ­¤è‡ªå‹•ç”¢ç”Ÿ backend çš„è…³æœ¬æœƒæ–¼ terraform/envs è³‡æ–™å¤¾å…§çš„ [README](../../../envs/README.md) èªªæ˜ã€‚

---

## å°çµ

è‹¥ Terraform ä¸­å¤šå€‹æ¨¡çµ„å…±äº«ç›¸åŒçš„ backend è¨­å®šè€Œæœªåšå€éš”ï¼Œå°±å¯èƒ½ç™¼ç”Ÿäº¤å‰èª¤åˆªã€è³‡æºé‡å»ºçš„æƒ…æ³ã€‚

ç¸½è€Œè¨€ä¹‹ï¼š**ç‹€æ…‹æª”çš„åŠƒåˆ†èˆ‡ç®¡ç†ï¼Œæ˜¯å¤šæ¨¡çµ„åŸºç¤æ¶æ§‹è¨­è¨ˆä¸­çš„é—œéµä¸€ç’°**ã€‚
